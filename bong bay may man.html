<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bóng Bay May Mắn</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            min-height: 100%;
            overflow-x: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff6b6b;
            --text-color: #333;
            --bg-panel: rgba(255,255,255,0.9);
            --shadow: rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --text-color: #ecf0f1;
            --bg-panel: rgba(52, 73, 94, 0.9);
            --shadow: rgba(0,0,0,0.3);
        }

        body.dark-mode .stat-label,
        body.dark-mode .input-help {
            color: #bdc3c7 !important;
        }

        body.dark-mode .student-textarea {
            background: rgba(44, 62, 80, 0.8);
            color: #ecf0f1;
            border-color: #7f8c8d;
        }

        body.dark-mode .student-name-tag {
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
        }

        .background-balloons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-balloon {
            position: absolute;
            font-size: 2rem;
            opacity: 0.3;
            animation: floatBackground 15s infinite linear;
        }

        @keyframes floatBackground {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            text-align: center;
            position: relative;
        }

        .main-game-area {
            grid-column: 1;
        }

        .sidebar {
            grid-column: 2;
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .control-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            background: var(--bg-panel);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow);
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .color-picker-container {
            position: relative;
        }

        .color-picker {
            position: absolute;
            top: 60px;
            right: 0;
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px var(--shadow);
            display: none;
            z-index: 1000;
        }

        .color-picker.active {
            display: block;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option:hover,
        .color-option.active {
            border-color: #fff;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }



        .difficulty-selector {
            margin: 20px 0;
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .difficulty-label {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .difficulty-btn.active {
            background: linear-gradient(45deg, var(--accent-color), #ee5a24);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .countdown-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .countdown-number {
            font-size: 8rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .special-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
        }

        .confetti {
            position: absolute;
            font-size: 1.5rem;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .game-title {
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .balloons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            min-height: 400px;
            align-items: flex-end;
        }

        .balloon {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            animation: float 4s ease-in-out infinite;
        }

        .balloon:hover {
            transform: scale(1.1);
        }

        .balloon:nth-child(odd) {
            animation-delay: -1s;
        }

        .balloon:nth-child(even) {
            animation-delay: -2s;
        }

        .balloon:nth-child(3n) {
            animation-delay: -0.5s;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(-2deg); 
            }
            25% { 
                transform: translateY(-15px) rotate(1deg); 
            }
            50% { 
                transform: translateY(-25px) rotate(-1deg); 
            }
            75% { 
                transform: translateY(-10px) rotate(2deg); 
            }
        }

        .balloon-emoji {
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .balloon-string {
            width: 2px;
            height: 40px;
            background: #8B4513;
            margin: 0 auto;
            position: relative;
        }

        .student-name-tag {
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 5px;
            box-shadow: 0 2px 8px var(--shadow);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .student-name-tag.called {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            text-decoration: line-through;
        }

        .controls {
            margin: 30px 0;
        }

        .game-button {
            background: linear-gradient(45deg, var(--accent-color), #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin: 0 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .game-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .reset-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .student-input-section {
            margin: 20px 0;
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .student-input-label {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .student-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }

        .student-textarea:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .input-help {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .update-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .update-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .clear-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            margin-left: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .clear-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .student-count {
            font-size: 1rem;
            color: var(--text-color);
            margin-top: 10px;
            font-weight: bold;
        }

        .winner-display {
            margin: 30px 0;
            padding: 20px;
            background: var(--bg-panel);
            color: var(--text-color);
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .winner-text {
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .winner-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .result-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .result-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 60px 80px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 5px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
            transform: scale(0.5);
            animation: resultAppear 0.8s ease-out forwards;
        }

        @keyframes resultAppear {
            0% {
                transform: scale(0.5) rotate(-10deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(5deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .result-title {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        .result-winner {
            font-size: 4rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin: 30px 0;
            animation: winnerPulse 1.5s ease-in-out infinite;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes glow {
            0% { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.3); }
            100% { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.6); }
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .result-close-btn {
            background: linear-gradient(45deg, var(--accent-color), #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .result-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .firework {
            position: absolute;
            pointer-events: none;
        }

        .firework-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: fireworkExplode 2s ease-out forwards;
        }

        @keyframes fireworkExplode {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(0) translate(var(--dx), var(--dy));
                opacity: 0;
            }
        }

        .sparkle {
            position: absolute;
            font-size: 2rem;
            animation: sparkleFloat 3s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkleFloat {
            0% {
                transform: translateY(0) rotate(0deg) scale(0);
                opacity: 1;
            }
            50% {
                transform: translateY(-50px) rotate(180deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg) scale(0);
                opacity: 0;
            }
        }

        .explosion {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }

        .particle {
            position: absolute;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: explode 1s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(0) translate(var(--dx), var(--dy));
                opacity: 0;
            }
        }

        .pop-animation {
            animation: pop 0.6s ease-out forwards;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(0); opacity: 0; }
        }

        .history-panel {
            margin-top: 20px;
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .history-list {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .history-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-size: 0.8rem;
            color: #666;
        }

        .clear-history-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .clear-history-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .fairness-panel {
            margin-top: 20px;
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .fairness-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .fairness-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fairness-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
            position: relative;
            padding-left: 30px;
        }

        .fairness-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            left: 0;
            top: 0;
        }

        .checkmark {
            position: absolute;
            left: 0;
            top: 2px;
            height: 18px;
            width: 18px;
            background-color: rgba(255,255,255,0.2);
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .fairness-option:hover .checkmark {
            background-color: rgba(255,255,255,0.3);
        }

        .fairness-option input:checked ~ .checkmark {
            background-color: var(--accent-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .fairness-option input:checked ~ .checkmark:after {
            display: block;
        }

        .probability-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .probability-title {
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .probability-list {
            font-size: 0.85rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .probability-item:last-child {
            border-bottom: none;
        }

        .probability-name {
            color: var(--text-color);
        }

        .probability-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        .probability-bar {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-left: 8px;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
        }

        .theme-panel {
            margin-top: 20px;
            background: var(--bg-panel);
            color: var(--text-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .theme-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .theme-selector {
            margin-bottom: 15px;
        }

        .theme-dropdown {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: var(--text-color);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-dropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        body.dark-mode .theme-dropdown {
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
            border-color: var(--accent-color);
        }

        .theme-preview {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--accent-color);
        }

        .preview-emojis {
            font-size: 1.5rem;
            margin-bottom: 8px;
            letter-spacing: 8px;
        }

        .preview-text {
            font-size: 0.85rem;
            color: var(--text-color);
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                grid-column: 1;
                position: static;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .balloon-svg {
                width: 60px;
                height: 75px;
            }
            
            .balloons-container {
                gap: 15px;
            }
            
            .winner-name {
                font-size: 2rem;
            }
            

            
            .difficulty-buttons {
                flex-direction: column;
                align-items: center;
            }

            .control-buttons {
                position: fixed;
                top: 10px;
                right: 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="background-balloons" id="backgroundBalloons"></div>
  <div class="special-effects" id="specialEffects"></div>
  <div class="countdown-overlay" id="countdownOverlay">
   <div class="countdown-number" id="countdownNumber">
    3
   </div>
  </div>
  <div class="result-overlay" id="resultOverlay">
   <div class="result-content">
    <div class="result-title" id="resultTitle">
     🎉 Kết quả 🎉
    </div>
    <div class="result-winner" id="resultWinner">
     Nguyễn Văn An
    </div><button class="result-close-btn" id="resultCloseBtn">Đóng</button>
   </div>
  </div>
  <div class="game-container">
   <div class="main-game-area">
    <div class="control-buttons"><button class="control-btn" id="soundToggle" title="Bật/tắt âm thanh">🔊</button> <button class="control-btn" id="darkModeToggle" title="Chế độ tối">🌙</button>
     <div class="color-picker-container"><button class="control-btn" id="colorToggle" title="Đổi màu chủ đạo">🎨</button>
      <div class="color-picker" id="colorPicker">
       <div class="color-options">
        <div class="color-option" data-color="#ff6b6b" style="background: #ff6b6b"></div>
        <div class="color-option" data-color="#4ecdc4" style="background: #4ecdc4"></div>
        <div class="color-option" data-color="#45b7d1" style="background: #45b7d1"></div>
        <div class="color-option" data-color="#96ceb4" style="background: #96ceb4"></div>
        <div class="color-option" data-color="#feca57" style="background: #feca57"></div>
        <div class="color-option" data-color="#ff9ff3" style="background: #ff9ff3"></div>
        <div class="color-option" data-color="#54a0ff" style="background: #54a0ff"></div>
        <div class="color-option" data-color="#5f27cd" style="background: #5f27cd"></div>
        <div class="color-option" data-color="#00d2d3" style="background: #00d2d3"></div>
        <div class="color-option" data-color="#ff9f43" style="background: #ff9f43"></div>
        <div class="color-option" data-color="#10ac84" style="background: #10ac84"></div>
        <div class="color-option" data-color="#ee5a24" style="background: #ee5a24"></div>
       </div>
      </div>
     </div>
    </div>
    <h1 class="game-title" id="gameTitle">🎈 Bóng Bay May Mắn 🎈</h1>
    <div class="balloons-container" id="balloonsContainer"><!-- Balloons will be generated here -->
    </div>
    <div class="controls"><button class="game-button" id="startButton">Bắt đầu</button> <button class="game-button reset-button" id="resetButton" style="display: none;">Chơi lại</button>
    </div>
    <div class="winner-display" id="winnerDisplay">
     <div class="winner-text" id="winnerText">
      Nhấn "Bắt đầu" để chọn học sinh may mắn!
     </div>
     <div class="winner-name" id="winnerName" style="display: none;"></div>
    </div>
   </div>
   <div class="sidebar">
    <div class="student-input-section">
     <div class="student-input-label" id="studentInputLabel">
      📝 Nhập danh sách học sinh:
     </div>
     <div class="student-input-label">
      Danh sách học sinh:
     </div><textarea class="student-textarea" id="studentTextarea" placeholder="Nhập tên học sinh, mỗi tên một dòng...
Ví dụ:
Nguyễn Văn An
Trần Thị Bình
Lê Hoàng Cường"></textarea>
     <div class="input-help">
      Mỗi tên học sinh trên một dòng riêng
     </div><button class="update-button" id="updateButton">Cập nhật bóng bay</button> <button class="clear-button" id="clearButton">Xóa danh sách</button>
     <div class="student-count" id="studentCount">
      Số học sinh: 0
     </div>
    </div>
    <div class="history-panel">
     <div class="history-title">
      📋 Lịch sử gọi tên hôm nay:
     </div>
     <div class="history-list" id="historyList">
      <div style="text-align: center; color: #666; font-style: italic;">
       Chưa có ai được gọi
      </div>
     </div><button class="clear-history-btn" id="clearHistoryBtn">Xóa lịch sử</button>
    </div>
    <div class="theme-panel">
     <div class="theme-title">
      🎨 Chọn chủ đề:
     </div>
     <div class="theme-selector"><select id="themeSelector" class="theme-dropdown"> <option value="balloons">🎈 Bóng bay cổ điển</option> <option value="animals">🐾 Động vật dễ thương</option> <option value="fruits">🍎 Trái cây tươi ngon</option> <option value="space">🚀 Vũ trụ kỳ diệu</option> <option value="ocean">🌊 Đại dương xanh</option> <option value="flowers">🌸 Vườn hoa rực rỡ</option> <option value="sports">⚽ Thể thao năng động</option> <option value="food">🍕 Món ăn ngon</option> <option value="weather">🌈 Thời tiết</option> <option value="transport">🚗 Phương tiện</option> </select>
     </div>
     <div class="theme-preview" id="themePreview">
      <div class="preview-emojis">
       🎈 🎀 🌟 💫 ✨
      </div>
      <div class="preview-text">
       Bóng bay cổ điển
      </div>
     </div>
    </div>
    <div class="fairness-panel">
     <div class="fairness-title">
      ⚖️ Đảm bảo công bằng:
     </div>
     <div class="fairness-options"><label class="fairness-option"> <input type="checkbox" id="preventDuplicates" checked> <span class="checkmark"></span> Không gọi lại người đã được gọi hôm nay </label> <label class="fairness-option"> <input type="checkbox" id="balancedSelection"> <span class="checkmark"></span> Chế độ cân bằng (mỗi người đều có cơ hội) </label> <label class="fairness-option"> <input type="checkbox" id="showProbability"> <span class="checkmark"></span> Hiển thị xác suất được chọn </label>
     </div>
     <div class="probability-display" id="probabilityDisplay" style="display: none;">
      <div class="probability-title">
       📊 Xác suất được chọn:
      </div>
      <div class="probability-list" id="probabilityList"></div>
     </div>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            game_title: "Bóng Bay May Mắn",
            start_button_text: "Bắt đầu",
            reset_button_text: "Chơi lại",
            winner_message: "Học sinh được gọi:"
        };

        let config = { ...defaultConfig };
        const themes = {
            balloons: {
                name: 'Bóng bay cổ điển',
                emojis: ['🎈', '🎀', '🌟', '💫', '✨', '🎊', '🎉', '🌈', '💖', '🦄'],
                backgroundEmojis: ['🎈', '🎀', '🌟', '💫', '✨', '🎊', '🎉', '🌈', '💖', '🦄'],
                celebrationEmojis: ['🎉', '🎊', '✨', '💫', '🌟', '🎈', '💖', '🦄', '🌈']
            },
            animals: {
                name: 'Động vật dễ thương',
                emojis: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵'],
                backgroundEmojis: ['🐾', '🦋', '🐝', '🐞', '🦄', '🐶', '🐱', '🐰', '🐻'],
                celebrationEmojis: ['🐾', '🦋', '🌟', '✨', '💫', '🎉', '🎊', '🐶', '🐱']
            },
            fruits: {
                name: 'Trái cây tươi ngon',
                emojis: ['🍎', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅'],
                backgroundEmojis: ['🍎', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈', '🍑'],
                celebrationEmojis: ['🍎', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '✨', '🌟']
            },
            space: {
                name: 'Vũ trụ kỳ diệu',
                emojis: ['🚀', '🛸', '🌟', '⭐', '🌙', '🪐', '🌍', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔'],
                backgroundEmojis: ['🚀', '🛸', '🌟', '⭐', '🌙', '🪐', '✨', '💫', '🌍'],
                celebrationEmojis: ['🚀', '🛸', '🌟', '⭐', '✨', '💫', '🎆', '🎇', '🌙']
            },
            ocean: {
                name: 'Đại dương xanh',
                emojis: ['🐠', '🐟', '🐡', '🦈', '🐙', '🦑', '🦀', '🦞', '🐚', '🪸', '🌊', '🏖️', '⛵', '🚢', '🐋'],
                backgroundEmojis: ['🌊', '🐠', '🐟', '🐡', '🐚', '⛵', '🏖️', '💙', '💎'],
                celebrationEmojis: ['🌊', '🐠', '🐟', '🐡', '🐚', '✨', '💫', '🌟', '💙']
            },
            flowers: {
                name: 'Vườn hoa rực rỡ',
                emojis: ['🌸', '🌺', '🌻', '🌷', '🌹', '🥀', '🌼', '🌵', '🌿', '🍀', '🌱', '🌳', '🌲', '🎋', '🪴'],
                backgroundEmojis: ['🌸', '🌺', '🌻', '🌷', '🌹', '🌼', '🌿', '🍀', '🦋'],
                celebrationEmojis: ['🌸', '🌺', '🌻', '🌷', '🌹', '🌼', '✨', '🌟', '💖']
            },
            sports: {
                name: 'Thể thao năng động',
                emojis: ['⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏓', '🏸', '🥅', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖️'],
                backgroundEmojis: ['⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏆', '🥇', '🏅'],
                celebrationEmojis: ['🏆', '🥇', '🥈', '🥉', '🏅', '🎖️', '✨', '🌟', '🎉']
            },
            food: {
                name: 'Món ăn ngon',
                emojis: ['🍕', '🍔', '🌭', '🥪', '🌮', '🌯', '🥙', '🧆', '🥘', '🍝', '🍜', '🍲', '🍱', '🍙', '🍘'],
                backgroundEmojis: ['🍕', '🍔', '🌭', '🥪', '🌮', '🍝', '🍜', '🍱', '🎂'],
                celebrationEmojis: ['🍕', '🍔', '🌭', '🥪', '🌮', '🎂', '✨', '🌟', '🎉']
            },
            weather: {
                name: 'Thời tiết',
                emojis: ['☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌈', '🌪️'],
                backgroundEmojis: ['☀️', '🌤️', '⛅', '☁️', '🌦️', '🌧️', '🌨️', '🌈', '❄️'],
                celebrationEmojis: ['☀️', '🌈', '⭐', '✨', '🌟', '💫', '🎆', '🎇', '🌤️']
            },
            transport: {
                name: 'Phương tiện',
                emojis: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎️', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🏍️'],
                backgroundEmojis: ['🚗', '🚕', '🚙', '🚌', '🏎️', '🚓', '🚑', '🚒', '✈️'],
                celebrationEmojis: ['🚗', '🚕', '🏎️', '✈️', '🚀', '✨', '🌟', '💫', '🎉']
            }
        };

        let gameState = {
            isPlaying: false,
            students: [],
            availableStudents: [],
            calledStudents: JSON.parse(localStorage.getItem('balloonGameCalledStudents') || '[]'),
            balloonColors: [
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
                '#10ac84', '#ee5a24', '#0984e3', '#6c5ce7', '#a29bfe',
                '#ff7675', '#74b9ff', '#00b894', '#fdcb6e', '#e17055',
                '#fd79a8', '#6c5ce7', '#a29bfe', '#00cec9', '#55a3ff'
            ],
            currentTheme: localStorage.getItem('balloonGameTheme') || 'balloons',
            currentMode: 'normal',
            fairnessSettings: {
                preventDuplicates: localStorage.getItem('balloonGamePreventDuplicates') !== 'false',
                balancedSelection: localStorage.getItem('balloonGameBalancedSelection') === 'true',
                showProbability: localStorage.getItem('balloonGameShowProbability') === 'true'
            },
            selectionWeights: JSON.parse(localStorage.getItem('balloonGameSelectionWeights') || '{}'),
            stats: {
                totalGames: parseInt(localStorage.getItem('balloonGameTotal') || '0'),
                currentStreak: parseInt(localStorage.getItem('balloonGameStreak') || '0'),
                bestStreak: parseInt(localStorage.getItem('balloonGameBestStreak') || '0'),
                startTime: null,
                playTime: parseInt(localStorage.getItem('balloonGamePlayTime') || '0'),
                modeStats: JSON.parse(localStorage.getItem('balloonGameModeStats') || '{"normal":0,"fast":0,"surprise":0}')
            },
            settings: {
                soundEnabled: localStorage.getItem('balloonGameSound') !== 'false',
                darkMode: localStorage.getItem('balloonGameDarkMode') === 'true',
                primaryColor: localStorage.getItem('balloonGamePrimaryColor') || '#ff6b6b'
            }
        };

        function render(newConfig) {
            config = { ...defaultConfig, ...newConfig };
            
            document.getElementById('gameTitle').textContent = config.game_title;
            document.getElementById('startButton').textContent = config.start_button_text;
            document.getElementById('resetButton').textContent = config.reset_button_text;
            
            if (!gameState.isPlaying) {
                document.getElementById('winnerText').textContent = `Nhấn "${config.start_button_text}" để chọn học sinh may mắn!`;
            } else {
                document.getElementById('winnerText').textContent = config.winner_message;
            }
        }

        function updateStats() {
            // Save to localStorage
            localStorage.setItem('balloonGameTotal', gameState.stats.totalGames.toString());
            localStorage.setItem('balloonGameStreak', gameState.stats.currentStreak.toString());
            localStorage.setItem('balloonGameBestStreak', gameState.stats.bestStreak.toString());
            localStorage.setItem('balloonGamePlayTime', gameState.stats.playTime.toString());
            localStorage.setItem('balloonGameModeStats', JSON.stringify(gameState.stats.modeStats));
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (gameState.calledStudents.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">Chưa có ai được gọi</div>';
                return;
            }

            // Lấy các học sinh được gọi hôm nay
            const today = new Date().toDateString();
            const todaysCalls = gameState.calledStudents.filter(call => 
                new Date(call.timestamp).toDateString() === today
            );

            if (todaysCalls.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">Chưa có ai được gọi hôm nay</div>';
                return;
            }

            historyList.innerHTML = todaysCalls
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10) // Chỉ hiển thị 10 lần gần nhất
                .map(call => {
                    const time = new Date(call.timestamp).toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="history-item">
                            <span>${call.name}</span>
                            <span class="history-time">${time}</span>
                        </div>
                    `;
                }).join('');

            // Save to localStorage
            localStorage.setItem('balloonGameCalledStudents', JSON.stringify(gameState.calledStudents));
        }

        function addToHistory(studentName) {
            const call = {
                name: studentName,
                timestamp: new Date().toISOString()
            };
            
            gameState.calledStudents.push(call);
            
            // Giữ lại tối đa 100 lần gọi gần nhất
            if (gameState.calledStudents.length > 100) {
                gameState.calledStudents = gameState.calledStudents.slice(-100);
            }
            
            updateHistory();
        }

        function clearHistory() {
            gameState.calledStudents = [];
            localStorage.removeItem('balloonGameCalledStudents');
            updateHistory();
        }

        function isStudentCalledToday(studentName) {
            const today = new Date().toDateString();
            return gameState.calledStudents.some(call => 
                call.name === studentName && 
                new Date(call.timestamp).toDateString() === today
            );
        }

        function calculateSelectionProbabilities() {
            if (gameState.students.length === 0) return {};
            
            let availableForSelection = [...gameState.students];
            
            // Nếu bật chế độ không trùng lặp, loại bỏ những người đã được gọi hôm nay
            if (gameState.fairnessSettings.preventDuplicates) {
                availableForSelection = availableForSelection.filter(name => !isStudentCalledToday(name));
                
                // Nếu tất cả đã được gọi, reset để mọi người có cơ hội lại
                if (availableForSelection.length === 0) {
                    availableForSelection = [...gameState.students];
                }
            }
            
            const probabilities = {};
            
            if (gameState.fairnessSettings.balancedSelection) {
                // Chế độ cân bằng: người ít được gọi có xác suất cao hơn
                const totalCalls = {};
                
                // Đếm số lần mỗi người đã được gọi (toàn thời gian)
                gameState.students.forEach(name => {
                    totalCalls[name] = gameState.calledStudents.filter(call => call.name === name).length;
                });
                
                // Tính trọng số ngược (người ít được gọi có trọng số cao hơn)
                const maxCalls = Math.max(...Object.values(totalCalls), 0);
                const weights = {};
                let totalWeight = 0;
                
                availableForSelection.forEach(name => {
                    // Trọng số = (maxCalls + 1) - số lần đã gọi
                    weights[name] = (maxCalls + 1) - totalCalls[name];
                    totalWeight += weights[name];
                });
                
                // Tính xác suất dựa trên trọng số
                availableForSelection.forEach(name => {
                    probabilities[name] = totalWeight > 0 ? (weights[name] / totalWeight) * 100 : 0;
                });
            } else {
                // Chế độ bình thường: xác suất đều nhau
                const equalProbability = availableForSelection.length > 0 ? 100 / availableForSelection.length : 0;
                availableForSelection.forEach(name => {
                    probabilities[name] = equalProbability;
                });
            }
            
            // Những người không thể được chọn có xác suất 0
            gameState.students.forEach(name => {
                if (!availableForSelection.includes(name)) {
                    probabilities[name] = 0;
                }
            });
            
            return probabilities;
        }

        function updateProbabilityDisplay() {
            const display = document.getElementById('probabilityDisplay');
            const list = document.getElementById('probabilityList');
            
            if (!gameState.fairnessSettings.showProbability) {
                display.style.display = 'none';
                return;
            }
            
            display.style.display = 'block';
            
            const probabilities = calculateSelectionProbabilities();
            
            if (Object.keys(probabilities).length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">Chưa có học sinh nào</div>';
                return;
            }
            
            // Sắp xếp theo xác suất giảm dần
            const sortedStudents = Object.entries(probabilities)
                .sort(([,a], [,b]) => b - a);
            
            list.innerHTML = sortedStudents.map(([name, probability]) => {
                const isCalledToday = isStudentCalledToday(name);
                const displayClass = isCalledToday ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';
                
                return `
                    <div class="probability-item" ${displayClass}>
                        <span class="probability-name">${name}</span>
                        <div style="display: flex; align-items: center;">
                            <span class="probability-value">${probability.toFixed(1)}%</span>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${probability}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectStudentWithFairness() {
            const probabilities = calculateSelectionProbabilities();
            const availableStudents = Object.keys(probabilities).filter(name => probabilities[name] > 0);
            
            if (availableStudents.length === 0) {
                // Fallback: chọn ngẫu nhiên từ tất cả học sinh
                return gameState.students[Math.floor(Math.random() * gameState.students.length)];
            }
            
            if (!gameState.fairnessSettings.balancedSelection) {
                // Chọn ngẫu nhiên đơn giản
                return availableStudents[Math.floor(Math.random() * availableStudents.length)];
            }
            
            // Chọn dựa trên trọng số
            const random = Math.random() * 100;
            let cumulative = 0;
            
            for (const name of availableStudents) {
                cumulative += probabilities[name];
                if (random <= cumulative) {
                    return name;
                }
            }
            
            // Fallback
            return availableStudents[availableStudents.length - 1];
        }

        function createBalloon(index, studentName, color) {
            const balloon = document.createElement('div');
            balloon.className = 'balloon';
            balloon.dataset.student = studentName;
            
            const currentThemeData = themes[gameState.currentTheme];
            const emoji = currentThemeData.emojis[index % currentThemeData.emojis.length];
            
            const isCalled = isStudentCalledToday(studentName);
            
            balloon.innerHTML = `
                <div class="balloon-emoji" style="color: ${color}; font-size: 4rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); ${isCalled ? 'opacity: 0.5;' : ''}">
                    ${emoji}
                </div>
                <div class="balloon-string"></div>
                <div class="student-name-tag ${isCalled ? 'called' : ''}">${studentName}</div>
            `;
            
            return balloon;
        }

        function updateStudentList() {
            const textarea = document.getElementById('studentTextarea');
            const text = textarea.value.trim();
            
            if (text === '') {
                gameState.students = [];
            } else {
                gameState.students = text.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
            }
            
            updateStudentCount();
            generateBalloons();
        }

        function updateStudentCount() {
            const count = gameState.students.length;
            const calledToday = gameState.students.filter(name => isStudentCalledToday(name)).length;
            document.getElementById('studentCount').textContent = `Số học sinh: ${count} (Đã gọi hôm nay: ${calledToday})`;
            
            // Cập nhật hiển thị xác suất
            updateProbabilityDisplay();
        }

        function generateBalloons() {
            const container = document.getElementById('balloonsContainer');
            container.innerHTML = '';
            
            if (gameState.students.length === 0) {
                container.innerHTML = '<div style="color: white; font-size: 1.2rem; margin: 40px 0;">Chưa có học sinh nào. Vui lòng nhập danh sách học sinh!</div>';
                return;
            }
            
            gameState.availableStudents = [...gameState.students];
            
            gameState.availableStudents.forEach((student, index) => {
                const color = gameState.balloonColors[index % gameState.balloonColors.length];
                const balloon = createBalloon(index, student, color);
                container.appendChild(balloon);
            });
        }

        // Âm thanh nâng cao với Web Audio API
        function playSound(type) {
            if (!gameState.settings.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                switch(type) {
                    case 'pop':
                        // Âm thanh nổ bóng bay
                        const popOsc = audioContext.createOscillator();
                        const popGain = audioContext.createGain();
                        popOsc.connect(popGain);
                        popGain.connect(audioContext.destination);
                        
                        popOsc.frequency.setValueAtTime(800, audioContext.currentTime);
                        popOsc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.15);
                        popGain.gain.setValueAtTime(0.4, audioContext.currentTime);
                        popGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                        popOsc.start();
                        popOsc.stop(audioContext.currentTime + 0.15);
                        break;
                        
                    case 'countdown':
                        // Âm thanh đếm ngược
                        const countOsc = audioContext.createOscillator();
                        const countGain = audioContext.createGain();
                        countOsc.connect(countGain);
                        countGain.connect(audioContext.destination);
                        
                        countOsc.frequency.setValueAtTime(600, audioContext.currentTime);
                        countGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                        countGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        countOsc.start();
                        countOsc.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'celebration':
                        // Âm thanh ăn mừng phức tạp hơn
                        const celebrationNotes = [523, 659, 784, 1047]; // C5, E5, G5, C6
                        celebrationNotes.forEach((freq, i) => {
                            setTimeout(() => {
                                const osc = audioContext.createOscillator();
                                const gain = audioContext.createGain();
                                osc.connect(gain);
                                gain.connect(audioContext.destination);
                                
                                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                                osc.start();
                                osc.stop(audioContext.currentTime + 0.4);
                            }, i * 150);
                        });
                        break;
                        
                    case 'shake':
                        // Âm thanh lắc bóng bay
                        const shakeOsc = audioContext.createOscillator();
                        const shakeGain = audioContext.createGain();
                        shakeOsc.connect(shakeGain);
                        shakeGain.connect(audioContext.destination);
                        
                        shakeOsc.frequency.setValueAtTime(400, audioContext.currentTime);
                        shakeOsc.frequency.linearRampToValueAtTime(500, audioContext.currentTime + 0.1);
                        shakeGain.gain.setValueAtTime(0.1, audioContext.currentTime);
                        shakeGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        shakeOsc.start();
                        shakeOsc.stop(audioContext.currentTime + 0.1);
                        break;
                }
            } catch (e) {
                // Âm thanh không khả dụng
            }
        }

        function setDifficulty(mode) {
            gameState.currentMode = mode;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        }

        function toggleDarkMode() {
            gameState.settings.darkMode = !gameState.settings.darkMode;
            document.body.classList.toggle('dark-mode', gameState.settings.darkMode);
            document.getElementById('darkModeToggle').textContent = gameState.settings.darkMode ? '☀️' : '🌙';
            localStorage.setItem('balloonGameDarkMode', gameState.settings.darkMode.toString());
        }

        function setThemeColor(color) {
            gameState.settings.primaryColor = color;
            document.documentElement.style.setProperty('--accent-color', color);
            
            // Tạo gradient màu nền dựa trên màu chủ đạo
            const lighterColor = adjustColorBrightness(color, 20);
            const darkerColor = adjustColorBrightness(color, -20);
            
            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--secondary-color', darkerColor);
            
            // Cập nhật gradient nền
            document.body.style.background = `linear-gradient(135deg, ${color} 0%, ${darkerColor} 100%)`;
            
            localStorage.setItem('balloonGamePrimaryColor', color);
            
            // Update active color option
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        // Hàm điều chỉnh độ sáng của màu
        function adjustColorBrightness(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function createConfetti() {
            const container = document.getElementById('specialEffects');
            const currentThemeData = themes[gameState.currentTheme];
            const confettiEmojis = currentThemeData.celebrationEmojis;
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 100);
            }
        }

        function createFireworks() {
            const container = document.getElementById('resultOverlay');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
            
            // Tạo nhiều đợt pháo hoa
            for (let wave = 0; wave < 5; wave++) {
                setTimeout(() => {
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const firework = document.createElement('div');
                            firework.className = 'firework';
                            firework.style.left = (20 + Math.random() * 60) + '%';
                            firework.style.top = (20 + Math.random() * 40) + '%';
                            
                            // Tạo các hạt pháo hoa
                            for (let j = 0; j < 20; j++) {
                                const particle = document.createElement('div');
                                particle.className = 'firework-particle';
                                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                                
                                const angle = (j / 20) * Math.PI * 2;
                                const distance = 80 + Math.random() * 60;
                                const dx = Math.cos(angle) * distance;
                                const dy = Math.sin(angle) * distance;
                                
                                particle.style.setProperty('--dx', dx + 'px');
                                particle.style.setProperty('--dy', dy + 'px');
                                
                                firework.appendChild(particle);
                            }
                            
                            container.appendChild(firework);
                            
                            setTimeout(() => firework.remove(), 2000);
                        }, i * 300);
                    }
                }, wave * 800);
            }
        }

        function createSparkles() {
            const container = document.getElementById('resultOverlay');
            const currentThemeData = themes[gameState.currentTheme];
            const sparkleEmojis = currentThemeData.celebrationEmojis;
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleEmojis[Math.floor(Math.random() * sparkleEmojis.length)];
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.animationDelay = Math.random() * 1 + 's';
                    
                    container.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 3000);
                }, i * 200);
            }
        }

        function showResultOverlay(studentName) {
            const overlay = document.getElementById('resultOverlay');
            const resultWinner = document.getElementById('resultWinner');
            const resultTitle = document.getElementById('resultTitle');
            
            resultTitle.textContent = config.winner_message || '🎉 Kết quả 🎉';
            resultWinner.textContent = studentName;
            
            overlay.classList.add('active');
            
            // Tạo hiệu ứng pháo hoa và sparkles
            setTimeout(() => {
                createFireworks();
                createSparkles();
                playSound('celebration');
            }, 400);
        }

        function hideResultOverlay() {
            const overlay = document.getElementById('resultOverlay');
            overlay.classList.remove('active');
            
            // Xóa tất cả hiệu ứng
            setTimeout(() => {
                const fireworks = overlay.querySelectorAll('.firework');
                const sparkles = overlay.querySelectorAll('.sparkle');
                fireworks.forEach(fw => fw.remove());
                sparkles.forEach(sp => sp.remove());
            }, 500);
        }

        function showCountdown() {
            return new Promise((resolve) => {
                const overlay = document.getElementById('countdownOverlay');
                const numberEl = document.getElementById('countdownNumber');
                let count = 3;
                
                // Adjust countdown based on difficulty
                if (gameState.currentMode === 'fast') count = 2;
                if (gameState.currentMode === 'surprise') count = Math.floor(Math.random() * 3) + 1;
                
                overlay.classList.add('active');
                
                const countInterval = setInterval(() => {
                    numberEl.textContent = count;
                    numberEl.style.animation = 'none';
                    setTimeout(() => {
                        numberEl.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                    
                    playSound('countdown');
                    
                    count--;
                    if (count < 0) {
                        clearInterval(countInterval);
                        overlay.classList.remove('active');
                        resolve();
                    }
                }, gameState.currentMode === 'fast' ? 800 : 1000);
            });
        }

        function createExplosion(x, y, color) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';
            
            // Tạo hiệu ứng pháo hoa với emoji theo chủ đề
            const currentThemeData = themes[gameState.currentTheme];
            const celebrationEmojis = currentThemeData.celebrationEmojis;
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
                particle.style.fontSize = '1.5rem';
                
                const angle = (i / 15) * Math.PI * 2;
                const distance = 80 + Math.random() * 40;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                particle.style.setProperty('--dx', dx + 'px');
                particle.style.setProperty('--dy', dy + 'px');
                
                explosion.appendChild(particle);
            }
            
            document.body.appendChild(explosion);
            
            setTimeout(() => {
                explosion.remove();
            }, 1000);
            
            playSound('pop');
        }

        function selectRandomBalloon() {
            const balloons = document.querySelectorAll('.balloon');
            if (balloons.length === 0) return;
            
            // Selection pattern
            let shakeCount = 3;
            let shakeInterval = 300;
            
            // Hiệu ứng lắc bóng bay trước khi chọn
            let currentShake = 0;
            const shakeIntervalId = setInterval(() => {
                const randomBalloon = balloons[Math.floor(Math.random() * balloons.length)];
                randomBalloon.classList.add('shake');
                playSound('shake');
                setTimeout(() => randomBalloon.classList.remove('shake'), 500);
                
                currentShake++;
                if (currentShake >= shakeCount) {
                    clearInterval(shakeIntervalId);
                    
                    // Chọn bóng bay cuối cùng với tính năng công bằng
                    setTimeout(() => {
                        const selectedStudentName = selectStudentWithFairness();
                        
                        // Tìm bóng bay tương ứng với học sinh được chọn
                        let selectedBalloon = null;
                        for (const balloon of balloons) {
                            if (balloon.dataset.student === selectedStudentName) {
                                selectedBalloon = balloon;
                                break;
                            }
                        }
                        
                        // Fallback nếu không tìm thấy bóng bay
                        if (!selectedBalloon) {
                            selectedBalloon = balloons[Math.floor(Math.random() * balloons.length)];
                        }
                        
                        const studentName = selectedBalloon.dataset.student;
                        
                        // Get balloon position for explosion
                        const rect = selectedBalloon.getBoundingClientRect();
                        const x = rect.left + rect.width / 2;
                        const y = rect.top + rect.height / 2;
                        
                        // Pop animation
                        selectedBalloon.classList.add('pop-animation');
                        
                        // Create explosion effect
                        setTimeout(() => {
                            createExplosion(x, y, '#ff6b6b');
                            createConfetti();
                            playSound('celebration');
                        }, 300);
                        
                        // Show winner with overlay
                        setTimeout(() => {
                            // Thêm vào lịch sử
                            addToHistory(studentName);
                            
                            // Hiển thị overlay kết quả với hiệu ứng pháo hoa
                            showResultOverlay(studentName);
                            
                            // Cập nhật UI bên dưới (ẩn đi)
                            document.getElementById('winnerText').textContent = config.winner_message;
                            document.getElementById('winnerName').textContent = studentName;
                            document.getElementById('winnerName').style.display = 'block';
                            
                            document.getElementById('startButton').style.display = 'none';
                            document.getElementById('resetButton').style.display = 'inline-block';
                            
                            gameState.isPlaying = false;
                            
                            // Update stats
                            gameState.stats.totalGames++;
                            gameState.stats.currentStreak++;

                            
                            if (gameState.stats.currentStreak > gameState.stats.bestStreak) {
                                gameState.stats.bestStreak = gameState.stats.currentStreak;
                            }
                            
                            // Update play time
                            if (gameState.stats.startTime) {
                                gameState.stats.playTime += Math.floor((Date.now() - gameState.stats.startTime) / 1000);
                            }
                            
                            updateStats();
                            updateStudentCount(); // Cập nhật số lượng học sinh đã gọi
                        }, 600);
                        
                        // Remove balloon
                        setTimeout(() => {
                            selectedBalloon.remove();
                        }, 600);
                    }, 500);
                }
            }, shakeInterval);
        }

        async function startGame() {
            if (gameState.isPlaying) return;
            
            if (gameState.students.length === 0) {
                document.getElementById('winnerText').textContent = 'Vui lòng nhập danh sách học sinh trước!';
                return;
            }
            
            gameState.isPlaying = true;
            gameState.stats.startTime = Date.now();
            document.getElementById('startButton').disabled = true;
            document.getElementById('winnerName').style.display = 'none';
            document.getElementById('winnerText').textContent = 'Chuẩn bị...';
            
            // Hiển thị đếm ngược
            await showCountdown();
            
            document.getElementById('winnerText').textContent = 'Đang chọn...';
            
            // Bắt đầu chọn bóng bay
            selectRandomBalloon();
            document.getElementById('startButton').disabled = false;
        }

        function resetGame() {
            gameState.isPlaying = false;
            document.getElementById('winnerName').style.display = 'none';
            document.getElementById('winnerText').textContent = `Nhấn "${config.start_button_text}" để chọn học sinh may mắn!`;
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('resetButton').style.display = 'none';
            
            generateBalloons();
        }

        function clearStudentList() {
            document.getElementById('studentTextarea').value = '';
            gameState.students = [];
            updateStudentCount();
            generateBalloons();
            
            // Reset game state if playing
            if (gameState.isPlaying) {
                resetGame();
            }
            
            document.getElementById('winnerText').textContent = `Nhấn "${config.start_button_text}" để chọn học sinh may mắn!`;
        }

        // Event listeners
        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('resetButton').addEventListener('click', resetGame);
        document.getElementById('updateButton').addEventListener('click', updateStudentList);
        document.getElementById('clearButton').addEventListener('click', clearStudentList);
        document.getElementById('resultCloseBtn').addEventListener('click', hideResultOverlay);
        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
        

        
        // Control buttons
        document.getElementById('soundToggle').addEventListener('click', () => {
            gameState.settings.soundEnabled = !gameState.settings.soundEnabled;
            localStorage.setItem('balloonGameSound', gameState.settings.soundEnabled.toString());
            document.getElementById('soundToggle').textContent = gameState.settings.soundEnabled ? '🔊' : '🔇';
            
            if (gameState.settings.soundEnabled) {
                playSound('countdown');
            }
        });

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        document.getElementById('colorToggle').addEventListener('click', () => {
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.classList.toggle('active');
        });

        // Color picker options
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                setThemeColor(option.dataset.color);
                document.getElementById('colorPicker').classList.remove('active');
            });
        });

        // Close color picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-picker-container')) {
                document.getElementById('colorPicker').classList.remove('active');
            }
        });

        function changeTheme(themeKey) {
            gameState.currentTheme = themeKey;
            localStorage.setItem('balloonGameTheme', themeKey);
            
            // Cập nhật preview
            updateThemePreview();
            
            // Tạo lại bóng bay với chủ đề mới
            generateBalloons();
            
            // Xóa nền cũ và tạo nền mới
            const backgroundContainer = document.getElementById('backgroundBalloons');
            backgroundContainer.innerHTML = '';
        }

        function updateThemePreview() {
            const currentThemeData = themes[gameState.currentTheme];
            const previewEmojis = document.querySelector('.preview-emojis');
            const previewText = document.querySelector('.preview-text');
            
            // Hiển thị 5 emoji đầu tiên của chủ đề
            previewEmojis.textContent = currentThemeData.emojis.slice(0, 5).join(' ');
            previewText.textContent = currentThemeData.name;
        }

        // Theme selector event listener
        document.getElementById('themeSelector').addEventListener('change', (e) => {
            changeTheme(e.target.value);
        });

        // Fairness settings event listeners
        document.getElementById('preventDuplicates').addEventListener('change', (e) => {
            gameState.fairnessSettings.preventDuplicates = e.target.checked;
            localStorage.setItem('balloonGamePreventDuplicates', e.target.checked.toString());
            updateProbabilityDisplay();
        });

        document.getElementById('balancedSelection').addEventListener('change', (e) => {
            gameState.fairnessSettings.balancedSelection = e.target.checked;
            localStorage.setItem('balloonGameBalancedSelection', e.target.checked.toString());
            updateProbabilityDisplay();
        });

        document.getElementById('showProbability').addEventListener('change', (e) => {
            gameState.fairnessSettings.showProbability = e.target.checked;
            localStorage.setItem('balloonGameShowProbability', e.target.checked.toString());
            updateProbabilityDisplay();
        });
        
        // Tạo nền bóng bay động theo chủ đề
        function createBackgroundBalloons() {
            const container = document.getElementById('backgroundBalloons');
            
            function addBalloon() {
                const currentThemeData = themes[gameState.currentTheme];
                const balloonEmojis = currentThemeData.backgroundEmojis;
                
                const balloon = document.createElement('div');
                balloon.className = 'bg-balloon';
                balloon.textContent = balloonEmojis[Math.floor(Math.random() * balloonEmojis.length)];
                balloon.style.left = Math.random() * 100 + '%';
                balloon.style.animationDelay = Math.random() * 5 + 's';
                balloon.style.animationDuration = (10 + Math.random() * 10) + 's';
                
                container.appendChild(balloon);
                
                setTimeout(() => {
                    if (balloon.parentNode) {
                        balloon.remove();
                    }
                }, 20000);
            }
            
            // Thêm bóng bay mới mỗi 2 giây
            setInterval(addBalloon, 2000);
            
            // Thêm một số bóng bay ban đầu
            for (let i = 0; i < 5; i++) {
                setTimeout(addBalloon, i * 400);
            }
        }

        // Initialize game
        function initializeGame() {
            updateStudentCount();
            generateBalloons();
            updateStats();
            updateHistory();
            createBackgroundBalloons();
            
            // Set initial UI state
            document.getElementById('soundToggle').textContent = gameState.settings.soundEnabled ? '🔊' : '🔇';
            document.getElementById('darkModeToggle').textContent = gameState.settings.darkMode ? '☀️' : '🌙';
            
            // Apply saved settings
            if (gameState.settings.darkMode) {
                document.body.classList.add('dark-mode');
            }
            
            setThemeColor(gameState.settings.primaryColor);
            
            // Set theme selector and preview
            document.getElementById('themeSelector').value = gameState.currentTheme;
            updateThemePreview();
            
            // Set fairness checkboxes
            document.getElementById('preventDuplicates').checked = gameState.fairnessSettings.preventDuplicates;
            document.getElementById('balancedSelection').checked = gameState.fairnessSettings.balancedSelection;
            document.getElementById('showProbability').checked = gameState.fairnessSettings.showProbability;
            
            updateProbabilityDisplay();
        }

        initializeGame();

        // Element SDK implementation
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                render,
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["game_title", config.game_title || defaultConfig.game_title],
                    ["start_button_text", config.start_button_text || defaultConfig.start_button_text],
                    ["reset_button_text", config.reset_button_text || defaultConfig.reset_button_text],
                    ["winner_message", config.winner_message || defaultConfig.winner_message]
                ])
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'990f984ef6f9e666',t:'MTc2MDg2OTc3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>